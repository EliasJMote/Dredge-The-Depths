pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
#include lighting.p8
#include particle_system.p8

function _init()

	-- version
	version = 0.1

	-- create player
	player = {}
	player.x = 64
	player.y = 64
	player.w = 16
	player.h = 8
	player.dx = 0
	player.dy = 0
	player.light_radius = 16

	-- add clouds
	clouds = {}
	add(clouds,{x=58,y=4,r=4,dx=0.1})
	add(clouds,{x=64,y=4,r=4,dx=0.1})
	add(clouds,{x=60,y=6,r=4,dx=0.1})
	add(clouds,{x=68,y=6,r=4,dx=0.1})

	add(clouds,{x=20,y=6,r=6,dx=0.05})
	add(clouds,{x=26,y=8,r=6,dx=0.05})

	-- add waves
	waves = {}
	for i=0,15 do
		add(waves,i*8)
	end

	light_sources = {{x=88,y=112,r=3}}

	beacons = {}

	-- add beacons
	--for i=0,3 do
	for i=0,2,2 do	
		add(beacons,{x=88+i*8,y=104,spr=33,timer=0,light_radius=6})
	end

	-- (x=88+4,y=104)

	-- add bubble emitters
	emitters = {}
	add(emitters,create_bubble_emitter(16,128))
	add(emitters,create_bubble_emitter(24,128))
	add(emitters,create_bubble_emitter(32,128))

	bubbles = {}

	timer = 0
end

function _update()
	player.x += player.dx
	player.y += player.dy

	-- player horizontal movement
	if(btn(0) and player.x > 0) then
		player.dx = -1
	elseif(btn(1) and player.x < 128 - player.w) then
		player.dx = 1
	else
		player.dx = 0
	end

	-- player vertical movement
	if(btn(2) and player.y > 16-4) then
		player.dy = -1
	elseif(btn(3) and player.y < 128 - 8) then
		player.dy = 1
	else
		player.dy = 0
	end

	-- move waves
	for i=1,#waves do
		waves[i] += 0.25
		if(waves[i] >= 128) then
			waves[i] = 0
		end
	end

	-- move clouds
	for i=1,#clouds do
		clouds[i].x += clouds[i].dx
		if(clouds[i].x >= 128) then
			clouds[i].x = 0
		end
	end

	-- update beacons
	for i=1,#beacons do
		local b = beacons[i]
		b.light_radius = 6 + 1.5 * sin(timer/60+0.5*(i-1))
	end

	-- update emitters
	for e in all(emitters) do
		e,bubbles = update_bubble_emitter(e,bubbles)
	end

	-- update bubbles
	for b in all(bubbles) do
		b,bubbles = update_bubble(b,bubbles)
	end

	timer += 1
end

function _draw()
	cls()			

	-- ocean background
	rectfill(0,0,127,4-1,5)
	rectfill(0,4,127,16-1,6)
	rectfill(0,16,127,64-1,12)
	rectfill(0,64,127,96-1,1)
	rectfill(0,96,127,128-1,0)

	-- draw bubble particles
	for b in all(bubbles) do
		circ(b.x,b.y,b.r,12)
	end

	-- draw waves
	for w in all(waves) do
		rectfill(w,16,w+4,16,7)
	end

	-- draw blocks
	spr(1,88,128-8)
	spr(1,88+8,128-8)
	spr(1,88+16,128-8)

	-- draw columns
	for i=0,2 do
		spr(32,16*i,128-16)
		spr(32,16*i,128-8,1,1,false,true)
	end

	-- draw light beacons
	for i=1,#beacons do
		local b = beacons[i]
		if(i%2 == 1) then
			spr(b.spr+flr(timer/30)%2,b.x,b.y,1,2)
		else
			spr(b.spr+flr((timer+30)/30)%2,b.x,b.y,1,2)
		end
	end

	-- draw the player
	palt(0,false)
	palt(2,true)
	spr(2+(flr(timer/6)%2)*2,player.x,player.y,2,1)
	palt(0,true)
	palt(2,false)
	
	--circle_lighting(player)
	multiple_circle_lighting(beacons)
	
	-- draw clouds
	for c in all(clouds) do
		circfill(c.x,c.y,c.r,13)
	end

	-- draw fog
	--[[for j=0,3,2 do
		for i=0,128,2 do
			rectfill(i,j,i,j,5)
		end
	end
	for j=4,15,2 do
		for i=0,128,2 do
			rectfill(i,j,i,j,6)
		end
	end]]

	-- draw health
	--rectfill(0,0,8,8,0)

	print("fps = " .. stat(7),0,0,8)
	print("cpu = " .. stat(1))
	print("depth = " .. player.y + player.h)
end
__gfx__
0101010103300cc02222222222222222222222222222222200000000000000000000000000000000000000000000000000000000000000000000000000000000
101010103073c07c8822222666622222222222266662222200000000000000000000000000000000000000000000000000000000000000000000000000000000
010101013003c00c8889922666622888222222266662288800000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101003300cc02222299999998666888999999999866600000000000000000000000000000000000000000000000000000000000000000000000000000000
010101010cc003302222299999998866888999999999886600000000000000000000000000000000000000000000000000000000000000000000000000000000
10101010c07c30738889922229222888882222222992288800000000000000000000000000000000000000000000000000000000000000000000000000000000
01010101c00c30038822222222922222222222222229966200000000000000000000000000000000000000000000000000000000000000000000000000000000
101010100cc003302222222222299662222222222222222200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333800000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b3b330800000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b3b330d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b3b330d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b3b330d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b3b330d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b3b330d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03b3b330d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d0000000d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
